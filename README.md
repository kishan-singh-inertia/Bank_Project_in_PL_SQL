## Bank Project in PL/SQL
---
# Table Creation. 
```sql
-- Table to store customer account information.
CREATE TABLE accounts (
  account_id      NUMBER(10) PRIMARY KEY,
  customer_name   VARCHAR2(100) NOT NULL,
  balance         NUMBER(15, 2) NOT NULL CHECK (balance >= 0),
  account_status  VARCHAR2(20) NOT NULL CHECK (account_status IN ('Active', 'Frozen', 'Closed'))
);

-- Table to log every single transaction for auditing.
CREATE TABLE account_Transactions (
  transaction_id      NUMBER(20) GENERATED BY DEFAULT ON NULL AS IDENTITY,
  account_id          NUMBER(10) REFERENCES accounts(account_id),
  transaction_type    VARCHAR2(20) NOT NULL,
  amount              NUMBER(15, 2) NOT NULL,
  transaction_timestamp TIMESTAMP DEFAULT SYSTIMESTAMP,
  CONSTRAINT pk_account_transactions PRIMARY KEY (transaction_id)
);
```
---
# Data.
```sql
INSERT INTO accounts (account_id, customer_name, balance, account_status)
VALUES (1001, 'Alice Smith', 5000.00, 'Active');

INSERT INTO accounts (account_id, customer_name, balance, account_status)
VALUES (1002, 'Bob Johnson', 1000.00, 'Active');

INSERT INTO accounts (account_id, customer_name, balance, account_status)
VALUES (1003, 'Charlie Brown', 200.00, 'Frozen');

COMMIT;
```
---
# Package with procedure for deposit,withdrawal and fund transfer.
```sql
CREATE OR REPLACE PACKAGE pkg_banking AS

  e_insufficient_funds EXCEPTION;
  e_invalid_account    EXCEPTION;
  e_account_frozen     EXCEPTION;
  e_negative_amount    EXCEPTION;

  PROCEDURE deposit_Funds (
    p_account_id IN accounts.account_id%TYPE,
    p_amount     IN accounts.balance%TYPE
  );


  PROCEDURE withdraw_Funds (
    p_account_id IN accounts.account_id%TYPE,
    p_amount     IN accounts.balance%TYPE
  );


  PROCEDURE transfer_Funds (
    p_from_account IN accounts.account_id%TYPE,
    p_to_account   IN accounts.account_id%TYPE,
    p_amount       IN accounts.balance%TYPE
  );
  

  FUNCTION get_Balance (
    p_account_id IN accounts.account_id%TYPE
  ) RETURN accounts.balance%TYPE;

END pkg_banking;
```
---
# Package Body.
Procedure for deposit,withdrawal and fund transfer.
Function to check balance.

```sql
CREATE OR REPLACE PACKAGE BODY pkg_banking AS

PROCEDURE log_transaction (
    p_account_id IN accounts.account_id%TYPE,
    p_type       IN account_Transactions.transaction_type%TYPE,
    p_amount     IN account_Transactions.amount%TYPE
) AS
BEGIN
    INSERT INTO account_Transactions (account_id, transaction_type, amount)
    VALUES (p_account_id, p_type, p_amount);
END;

FUNCTION get_Balance (
    p_account_id IN accounts.account_id%TYPE
    ) RETURN accounts.balance%TYPE AS
    v_balance accounts.balance%TYPE;
BEGIN
    SELECT v_balance INTO v_balance FROM accounts
    WHERE account_id = p_account_id;
    RETURN v_balance;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
    RAISE e_invalid_account;
END;

PROCEDURE deposit_funds(
    p_account_id IN accounts.account_id%TYPE,
    p_amount IN accounts.balance%TYPE
) AS
    v_status accounts.account_status%TYPE;
BEGIN
    IF p_amount <=0 THEN
        RAISE e_negative_amount;
    END IF;

    SELECT account_status INTO v_status
    FROM accounts 
    WHERE account_id = p_account_id
    FOR UPDATE;

    IF v_status <> 'Active' THEN
        RAISE e_account_frozen;
    END IF;

    UPDATE accounts
    SET balance = balance + p_amount
    WHERE account_id = p_account_id;

    log_transaction(p_account_id,'Deposit',p_amount);

    COMMIT;
 EXCEPTION
    WHEN NO_DATA_FOUND THEN
      ROLLBACK;
      RAISE_APPLICATION_ERROR(-20002, 'Account ' || p_account_id || ' does not exist.');
    WHEN e_negative_amount THEN
      ROLLBACK;
      RAISE_APPLICATION_ERROR(-20004, 'Deposit amount must be positive.');
    WHEN e_account_frozen THEN
      ROLLBACK;
      RAISE_APPLICATION_ERROR(-20003, 'Account ' || p_account_id || ' is frozen.');
    WHEN OTHERS THEN
      ROLLBACK;
      RAISE_APPLICATION_ERROR(-20999, 'Something went wrong. : ' || SQLERRM);
END;


PROCEDURE withdraw_funds (
    p_account_id IN accounts.account_id%TYPE,
    p_amount     IN accounts.balance%TYPE
  ) AS
    v_balance Accounts.balance%TYPE;
    v_status  Accounts.account_status%TYPE;
BEGIN
    IF p_amount <=0 THEN
        RAISE e_negative_amount;
    END IF;

    SELECT balance,account_status INTO v_balance, v_status
    FROM accounts 
    WHERE account_id = p_account_id
    FOR UPDATE;

    IF v_status <> 'Active' THEN
        RAISE e_account_frozen;
    END IF;

    IF v_balance < p_amount THEN
        RAISE e_insufficient_funds;
    END IF;

    UPDATE accounts
    SET balance = balance - p_amount
    WHERE account_id = p_account_id;

    log_transaction(p_account_id, 'withdrawal', p_amount);

    COMMIT;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
      ROLLBACK;
      RAISE_APPLICATION_ERROR(-20002, 'Account ' || p_account_id || ' does not exist.');
    WHEN e_insufficient_funds THEN
      ROLLBACK;
      RAISE_APPLICATION_ERROR(-20001, 'Insufficient funds. Balance: ' || v_balance);
    WHEN e_negative_amount THEN
      ROLLBACK;
      RAISE_APPLICATION_ERROR(-20004, 'Withdrawal amount must be positive.');
    WHEN e_account_frozen THEN
      ROLLBACK;
      RAISE_APPLICATION_ERROR(-20003, 'Account ' || p_account_id || ' is frozen.');
    WHEN OTHERS THEN
      ROLLBACK;
      RAISE_APPLICATION_ERROR(-20999, 'Something went wrong: ' || SQLERRM);
END;

PROCEDURE transfer_funds (
    p_from_account IN accounts.account_id%TYPE,
    p_to_account   IN accounts.account_id%TYPE,
    p_amount       IN accounts.balance%TYPE
  ) AS
    v_from_balance accounts.balance%TYPE;
    v_from_status  accounts.account_status%TYPE;
    v_to_status    accounts.account_status%TYPE;
BEGIN
    IF p_amount <=0 THEN
        RAISE e_negative_amount;
    END IF;

    IF p_from_account = p_to_account THEN
        RAISE_APPLICATION_ERROR(-20035, 'Both account number are same.');
    END IF;

    IF p_from_account < p_to_account THEN
        SELECT balance, account_status 
        INTO v_from_balance, v_from_status FROM accounts
        WHERE account_id = p_from_account
        FOR UPDATE;
        SELECT account_status 
        INTO v_to_status FROM accounts
        WHERE account_id = p_to_account
        FOR UPDATE;
    ELSE
        SELECT account_status 
        INTO v_to_status FROM accounts
        WHERE account_id = p_to_account
        FOR UPDATE;
        SELECT balance, account_status 
        INTO v_from_balance, v_from_status FROM accounts
        WHERE account_id = p_from_account
        FOR UPDATE;
    END IF;

    IF v_from_status <> 'Active' THEN
        RAISE e_account_frozen;
    END IF;

    IF v_to_status <> 'Active' THEN
        RAISE e_account_frozen;
    END IF;
    
    IF v_from_balance < p_amount THEN
      RAISE e_insufficient_funds;
    END IF;

    UPDATE Accounts
    SET balance = balance - p_amount
    WHERE account_id = p_from_account;
    
    UPDATE Accounts
    SET balance = balance + p_amount
    WHERE account_id = p_to_account;


    log_transaction(p_from_account, 'TR-OUT', p_amount);
    log_transaction(p_to_account, 'TR-IN', p_amount);

    COMMIT;
EXCEPTION

    WHEN NO_DATA_FOUND THEN
      ROLLBACK;
      RAISE_APPLICATION_ERROR(-20002, 'Atleast one account id is wrong.');
    WHEN e_insufficient_funds THEN
      ROLLBACK;
      RAISE_APPLICATION_ERROR(-20001, 'Insufficient funds for transfer.');
    WHEN e_negative_amount THEN
      ROLLBACK;
      RAISE_APPLICATION_ERROR(-20004, 'Invalid Amount.');
    WHEN e_account_frozen THEN
      ROLLBACK;
      RAISE_APPLICATION_ERROR(-20003, 'One or both accounts are frozen.');
    WHEN OTHERS THEN
      ROLLBACK;
      RAISE_APPLICATION_ERROR(-20999, 'Something went wrong: ' || SQLERRM);

    END;

END pkg_banking;

```
---
# Testing.

Active accounts.
```sql
SELECT * FROM accounts 
WHERE account_id IN (1001,1002);

BEGIN
  pkg_banking.transfer_Funds(1001,1002,1000);
END;
/

SELECT * FROM accounts 
WHERE account_id IN (1001,1002);

SELECT * FROM account_Transactions;
```

Frozen account.
```sql
SELECT * FROM accounts 
WHERE account_id IN (1001,1003);

BEGIN
  pkg_banking.transfer_Funds(1001,1003,1000);
END;
/

SELECT * FROM accounts 
WHERE account_id IN (1001,1003);

SELECT * FROM account_Transactions;
```
---
